# mac-only release build that runs after rust-release completes successfully
name: mac-release-branch

on:
  workflow_run:
    workflows: ["rust-release"]
    types: [completed]

permissions:
  actions: read
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.id }}
  cancel-in-progress: true

jobs:
  guard:
    runs-on: ubuntu-latest
    # Only continue when rust-release succeeded and the triggering ref is a rust-v* tag
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'rust-v')
    outputs:
      tag: ${{ steps.extract_tag.outputs.tag }}
    steps:
      - name: Extract tag
        id: extract_tag
        run: |
          set -euo pipefail
          tag="${{ github.event.workflow_run.head_branch }}"
          if [[ -z "$tag" ]]; then
            echo "head_branch empty; skipping" >&2
            exit 1
          fi
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

  tag-check:
    needs: guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.guard.outputs.tag }}

      - name: Validate tag format
        shell: bash
        run: |
          set -euo pipefail
          [[ "${{ needs.guard.outputs.tag }}" =~ ^rust-v([0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9\.]+)?)$ ]] \
            || { echo "Tag '${{ needs.guard.outputs.tag }}' must look like rust-v<semver>"; exit 1; }

  tap-update:
    name: Update homebrew tap
    needs: tag-check
    runs-on: ubuntu-latest
    env:
      TAP_REPO: mazdak/homebrew-tap
      FORMULA_PATH: Formula/codex.rb
    steps:
      - name: Download mac artifacts from rust-release
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          pattern: "*apple-darwin"
          path: dist
          merge-multiple: true

      - name: Compute shas
        id: shas
        shell: bash
        env:
          RELEASE_TAG: ${{ needs.guard.outputs.tag }}
        run: |
          set -euo pipefail
          version="${RELEASE_TAG#rust-v}"
          arm_file="$(find dist -name 'codex-aarch64-apple-darwin.tar.gz' -print -quit)"
          x86_file="$(find dist -name 'codex-x86_64-apple-darwin.tar.gz' -print -quit)"
          [[ -n "$arm_file" && -f "$arm_file" ]] || { echo "missing mac artifact for arm"; find dist -maxdepth 3 -type f; exit 1; }
          [[ -n "$x86_file" && -f "$x86_file" ]] || { echo "missing mac artifact for x86"; find dist -maxdepth 3 -type f; exit 1; }
          arm_sha="$(sha256sum "$arm_file" | cut -d' ' -f1)"
          x86_sha="$(sha256sum "$x86_file" | cut -d' ' -f1)"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "arm_sha=$arm_sha" >> "$GITHUB_OUTPUT"
          echo "x86_sha=$x86_sha" >> "$GITHUB_OUTPUT"

      - name: Checkout tap
        uses: actions/checkout@v6
        with:
          repository: ${{ env.TAP_REPO }}
          token: ${{ secrets.TAP_PUSH_TOKEN }}

      - name: Update formula
        shell: bash
        run: |
          set -euo pipefail
          version="${{ steps.shas.outputs.version }}"
          arm_sha="${{ steps.shas.outputs.arm_sha }}"
          x86_sha="${{ steps.shas.outputs.x86_sha }}"
          cat > "${FORMULA_PATH}" <<'RUBY'
class Codex < Formula
  desc "Codex CLI"
  homepage "https://github.com/mazdak/codex"
RUBY
          cat >> "${FORMULA_PATH}" <<RUBY
  version "${version}"

  on_macos do
    on_arm do
      url "https://github.com/mazdak/codex/releases/download/rust-v#{version}/codex-aarch64-apple-darwin.tar.gz"
      sha256 "${arm_sha}"
    end
    on_intel do
      url "https://github.com/mazdak/codex/releases/download/rust-v#{version}/codex-x86_64-apple-darwin.tar.gz"
      sha256 "${x86_sha}"
    end
  end

  def install
    bin.install "codex"
  end

  test do
    system "#{bin}/codex", "--version"
  end
end
RUBY

      - name: Commit and push
        if: ${{ secrets.TAP_PUSH_TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${FORMULA_PATH}"
          git commit -m "codex ${{ needs.guard.outputs.tag }}"
          git push origin HEAD
