name: Update Homebrew tap

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to publish (e.g., rust-v0.88.0)"
        required: true

permissions:
  contents: read

jobs:
  update_homebrew:
    if: ${{ github.event_name != 'release' || github.event.release.prerelease == false }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Checkout homebrew-tap
        uses: actions/checkout@v6
        with:
          repository: mazdak/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        env:
          TAP_REPO: ${{ github.workspace }}/homebrew-tap
          CODEX_RELEASE_TAG: ${{ inputs.release_tag || github.event.release.tag_name }}
        run: |
          bash scripts/update-brew-formula.sh

      - name: Commit and push
        env:
          CODEX_RELEASE_TAG: ${{ inputs.release_tag || github.event.release.tag_name }}
        run: |
          cd homebrew-tap
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No Homebrew changes to commit."
            exit 0
          fi
          version="${CODEX_RELEASE_TAG#rust-v}"
          git config user.name "codex-release-bot"
          git config user.email "actions@users.noreply.github.com"
          git add Formula/codex.rb
          git commit -m "Update codex to ${version}"
          git push
